<!DOCTYPE html>
<html lang="ja-jp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css?family=Lato%3a900" rel="stylesheet" type="text/css">

    <link rel="shortcut icon" href="./images/unicorn.ico">
    
    <meta name="og:title" content="コマンドラインのオプションの設計について" />
    <meta name="og:description"
        content="※この記事はフラーAdvent Calendar 2019の12日目です。11日目は@okuzawatsさんでフラー株式会社でもバグバッシュ大会をやってみたでした。
はじめに 私は業務効率化のためのCLIを実装することが多い。 いざ実装して使ってみたら直感的に操作しにくいあるいは、理解しにくいなと思うことが度々ある。
そこで今回はコマンドラインのオプションについて調べてみた。
POSIX POSIX とは Portable operating system interface の略であり、異なるOS間で移植性に優れたソフトウェアを開発するための規格である。
POSIXの規格についてはUtility Conventionsが参考になる。
GNU POSIXに対し、GNUでも独自の規格が定められている。
ここで大事なのは、 GNU規格はPOSIX規格を拡張したものであるということである。実際に、Standards for Command Line Interfacesでも
 It is a good idea to follow the POSIX guidelines for the command-line options of a program. The easiest way to do this is to use getopt to parse them. Note that the GNU version of getopt will normally permit options anywhere among the arguments unless the special argument ‘&ndash;’ is used." />
    <meta name="og:image" content="https://shmokmt.github.io/images/avator.png" />
    <meta name="twitter:url" content="https://sh-tech.work/post/2019/12/cli-design/" />
    <meta name="twitter:site" />
    <meta name="twitter:creator" />
    <meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="/css/sanitize.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/highlight_solarized_dark.css">
    <link rel="stylesheet/less" href="/css/theme.less">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="alternate" href="/index.xml" type="application/rss+xml" title="shmokmt">
    
    <link rel="stylesheet" href="/css/font-awesome-4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/hover.css">
    <title>
        コマンドラインのオプションの設計について | shmokmt
    </title>

    <script src="/js/less.js" type="text/javascript"></script>
</head>



<body>
    <div class="container">
        <header role="banner">
            <div class="row gutters">
                <div id="site-title" class="col span_6">
                    <h1 class="site-title"><a href="/">shmokmt</a></h1>
                    
                    
                </div>
                <div id="social" class="col span_6">
                    <ul>
                        <li><a href="https://twitter.com/shmokmt" target="_blank">Twitter</a></li>
                        <li><a href="https://github.com/shmokmt" target="_blank">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </header>


<main id="single" role="main">
  <div class="article-header">
    <h1>コマンドラインのオプションの設計について</h1>
    <div class="meta">
      
      Dec 11, 2019 &nbsp;
      
      
    </div>
  </div>
  <article>
    <p>※この記事は<a href="https://adventar.org/calendars/4155">フラーAdvent Calendar 2019</a>の12日目です。11日目は<a href="https://twitter.com/okuzawats">@okuzawats</a>さんで<a href="https://allyourbase.hatenablog.com/entry/fuller-advent-calendar-20191211">フラー株式会社でもバグバッシュ大会をやってみた</a>でした。</p>
<h1 id="heading">はじめに</h1>
<p>私は業務効率化のためのCLIを実装することが多い。
いざ実装して使ってみたら直感的に操作しにくいあるいは、理解しにくいなと思うことが度々ある。</p>
<p>そこで今回はコマンドラインのオプションについて調べてみた。</p>
<h2 id="posix">POSIX</h2>
<p>POSIX とは Portable operating system interface の略であり、異なるOS間で移植性に優れたソフトウェアを開発するための規格である。</p>
<p>POSIXの規格については<a href="https://pubs.opengroup.org/onlinepubs/009696899/basedefs/xbd_chap12.html">Utility Conventions</a>が参考になる。</p>
<h2 id="gnu">GNU</h2>
<p>POSIXに対し、GNUでも独自の規格が定められている。</p>
<p>ここで大事なのは、 <strong>GNU規格はPOSIX規格を拡張したもの</strong>であるということである。実際に、<a href="https://www.gnu.org/prep/standards/html_node/Command_002dLine-Interfaces.html">Standards for Command Line Interfaces</a>でも</p>
<blockquote>
<p>It is a good idea to follow the POSIX guidelines for the command-line options of a program. The easiest way to do this is to use getopt to parse them. Note that the GNU version of getopt will normally permit options anywhere among the arguments unless the special argument ‘&ndash;’ is used. This is not what POSIX specifies; it is a GNU extension.</p>
</blockquote>
<p>と述べられている。</p>
<h1 id="command-line-option-pattern">Command Line Option Pattern</h1>
<p>今回は実際に私が業務で使用しているPython製のCLIライブラリである<a href="https://github.com/pallets/click">Click</a>を例にオプションの設計パターンを紹介する。</p>
<iframe class="hatenablogcard" style="width:100%;height:155px;max-width:420px;"
    src="https://hatenablog-parts.com/embed?url=https%3a%2f%2fgithub.com%2fpallets%2fclick" title="" width="300" height="150"
    frameborder="0" scrolling="no">
</iframe>
<h2 id="short-options--long-options">short options / long options</h2>
<p>多くのオプションは short option と long option を持つ。short option は<strong>利便性</strong>、long option は<strong>可読性</strong>を高める。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@click.command</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">-s</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--string-to-echo</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">echo</span>(string_to_echo):
    click<span style="color:#f92672">.</span>echo(string_to_echo)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$  hello --s okasho
okasho
</code></pre></div><p>※short option は利便性を高めるためのものである。したがって、<code>--dry-run</code>, <code>--force</code> など破壊的な操作を伴うものはshort option を用意しないほうがベターであると個人的に思っている。</p>
<p>GNU製のコマンドの long option に対してどのような short option が設定されているかは<a href="https://www.gnu.org/prep/standards/html_node/Option-Table.html#Option-Table">Table of Long Options</a>が参考になる。</p>
<h2 id="basic-value-options">basic value options</h2>
<p>オプションは値を持つことができる。値を持たせるときに主に以下について考えると良い。</p>
<ul>
<li>適切なデフォルト値</li>
<li>必須オプションかどうか</li>
<li>型(文字列/数値)</li>
</ul>
<p>基本的に必須オプション、デフォルト値のどちらかが設定されるべきことが多い。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@click.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--n</span><span style="color:#e6db74">&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dots</span>(n):
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> n)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@click.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--n</span><span style="color:#e6db74">&#39;</span>, required<span style="color:#f92672">=</span>True, type<span style="color:#f92672">=</span>int)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dots</span>(n):
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> n)
</code></pre></div><h2 id="choice-options">choice options</h2>
<p>取りうる値が限定的である場合はユーザに選択肢を与えるほうがよりユーザーフレンドリーである。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@click.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--office</span><span style="color:#e6db74">&#39;</span>,
              type<span style="color:#f92672">=</span>click<span style="color:#f92672">.</span>Choice([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">kashiwanoha</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">niigata</span><span style="color:#e6db74">&#39;</span>], required<span style="color:#f92672">=</span>True))
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fuller</span>(office):
    click<span style="color:#f92672">.</span>echo(office)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
$ fuller --office<span style="color:#f92672">=</span>niigata
niigata

$ fuller --office<span style="color:#f92672">=</span>foo
Usage: fuller <span style="color:#f92672">[</span>OPTIONS<span style="color:#f92672">]</span>
Try <span style="color:#e6db74">&#34;fuller --help&#34;</span> <span style="color:#66d9ef">for</span> help.

Error: Invalid value <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;--office&#34;</span>: invalid choice: foo. <span style="color:#f92672">(</span>choose from kashiwanoha, niigata<span style="color:#f92672">)</span>

$ fuller --help
Usage: fuller <span style="color:#f92672">[</span>OPTIONS<span style="color:#f92672">]</span>

Options:
  --office <span style="color:#f92672">[</span>kashiwanoha|niigata<span style="color:#f92672">]</span>
  --help                  Show this message and exit.
</code></pre></div><h2 id="flag-option">flag option</h2>
<p>Boolean をもたせたいときは以下のようにする。
※Flaseのオプション名を付与しないこともできる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@click.command</span>()
<span style="color:#a6e22e">@click.option</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">--dry-run/--no-dry-run</span><span style="color:#e6db74">&#39;</span>, default<span style="color:#f92672">=</span>True)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(dry_run):
    <span style="color:#66d9ef">if</span> dry_run:
        click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dry-run mode.</span><span style="color:#e6db74">&#34;</span>)
    click<span style="color:#f92672">.</span>echo(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Deleting...</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><h1 id="heading1">さいごに</h1>
<p>今回はコマンドラインのオプションの基本的なパターンについて紹介した。</p>
<p>現代では <a href="https://github.com/aws/aws-cli">aws-cli</a> や <a href="https://cloud.google.com/sdk/gcloud/?hl=ja">gcloud</a> のように多数のサブコマンドを含めたようなCLIも多く、サブコマンドが多くなればなるほどCLIの複雑さは増していくためよりオプション設計が重要になってくる。(※グローバルオプション等)</p>
<p>コマンドラインやOS、ネットワークなど古き良き技術の設計思想などは現代でも色褪せることなく、私たちに大きな気付きを与えてくれる。</p>
<h1 id="refs">Refs</h1>
<ul>
<li><a href="http://yapcasia.org/2014/talk/show/b49cc53a-027b-11e4-9357-07b16aeab6a4">コマンドラインツールについて語るときに僕の語ること</a></li>
<li><a href="https://deeeet.com/writing/2014/08/27/cli-reference/">コマンドラインツールを作るときに参考にしている資料</a></li>
<li><a href="https://blog.yuuk.io/entry/go-cli-unix">Go言語によるCLIツール開発とUNIX哲学について</a></li>
<li><a href="http://yohshiy.blog.fc2.com/blog-entry-260.html">コマンドラインプログラムにおける引数、オプションなどの標準仕様</a></li>
<li><a href="https://amzn.to/2E7X0w3">UNIXという考え方</a></li>
</ul>
<br>
    <div class="social">
    
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="shmokmt"
        data-count="horizontal">Tweet</a>
    
    
</div>
  </article>
</main>


  
  <footer role="contentinfo">
    <div class="header-logo" style="text-align:center;">
        <a href="http://b4b4r07.com"></a><br>
      copyright © shmokmt 2019 All Right Reserved.
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-129064258-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>



<script>
  $(document).ready(function() {
  
  $('p:has(img)').css('text-align', 'center');
  $('iframe').css('style', 'display: block; margin: 0px auto;');
  });
</script>
